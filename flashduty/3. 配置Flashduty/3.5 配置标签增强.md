## 快速了解
---
FlashDuty故障详情中的故障标签以key:value的形式展示告警的各类信息，这些标签信息来源于接入到FlashDuty的各类告警事件，当系统以源数据自动生成的标签无法满足业务时，可以通过**标签增强**为告警丰富更多标签信息，提升故障处理效率

## 标签的用途
---
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-3.png)

## 配置方式
---
- 集成中心的各个告警事件都具备标签增强配置选项（自定义事件除外），可以在创建告警事件完成后配置标签增强；标签增强分为提取、组合、映射、删除四种类型：
    - 提取：可以在告警标题、描述、标签中根据正则提取出value，生成新的标签
    - 组合：组合规则可以通过Go语言模板语法构建新的标签，以{{.Labels.Field}}格式来提取标签值或采用固定值的方式生成新的标签
    - 映射：预先[创建schema](https://developer.flashcat.cloud/api-142409927)映射关系和[上传元数据](https://developer.flashcat.cloud/api-145679479)后才可以配置，具体配置参考下文中的配置示例
    - 删除：即删除指定名称的标签，如果删除的标签不存在则无效

![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-1.png)

- 在进行标签增强时，可以配置前提条件规则来限制是否生成或删除相应的标签，当有限制时，如果不匹配条件则不生成或删除标签

![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-2.png)

- 根据设定条件生成新标签时，可以选择是否覆盖原标签，比如根据规则新生成一个名为host，值为A的标签，如果标签host在原告警中已存在，则会覆盖原标签

- 配置完成规则后，支持预览，可以直观的观察规则配置效果

![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-4.png)

::: highlight orange

标签规则可以配置多个，多个规则时会从上而下的顺序执行，当其中有规则不匹配时则不会生成/删除对应的标签，且没有提示信息；

:::

## 配置示例
---
- **提取：** 告警事件来自邮件集成，需要从描述信息中提取关键信息作为标签应用到其他场景

    - 告警原文：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-6.png)
    - 提取规则：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-5.png)
    - 提取效果：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-7.png)

- **组合：** 公司的日志平台可以通过域名+事件ID+时间戳的方式直接定位到日志详情，但告警信息中只有事件ID和时间戳标签，所以需要根据这些信息组合成一个访问地址
    - 告警原文：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-8.png)
    - 组合规则：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-9.png)
    - 组合效果：
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-10.png)

- **映射：** 当源告警信息中的标签值不固定且不能直观定位其含义的可以通过映射的方式，将源标签映射新定义标签和值；比如源告警中只有资源类型ID信息，但希望将每个ID对应的资源类型名称也体现出来，这时可以通过映射实现
1. 先创建schema映射关系，比如需要映射标签有：ID->Type，Level->DLevel（示例是映射两个标签）

| 源标签01 | 目标标签01 | 源标签02 | 目标标签02|
| :---: | :---: | :---: | --- |
| ID | Type | Level |Dlevel|

    ```
    # 创建schema，source_labels和result_labels分别表示源标签和目标标签
    curl --location --request POST 'https://api.flashcat.cloud/enrichment/mapping/schema/create?app_key={}' \
    --header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "schema_name": "zabbix mapping",
        "description": "Mapping test",
        "source_labels": [
            "ID",
            "Level"
        ],
        "result_labels": [
            "Type",
            "Dlevel"
        ]
    }'
    ```

2. 上传映射表（需要CSV格式）

| ID | Type | Level |Dlevel|
| :---: | :---: | :---: | --- |
| A | server | 1 |停服|
| B | router | 2 |危险|
| C | gateway | 3 |警告|
| D | database | 4 |注意|
| E | MQ | 5 |提醒|

    ```
    curl --location --request POST 'https://api.flashcat.cloud/enrichment/mapping/data/upload?schema_id={}&app_key={}' \
    --header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
    --header 'Content-Type: multipart/form-data' \
    --form 'file=@"./test.csv"'
    ```

3. 配置映射关系
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-11.png)

- 原告警
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-12.png)

- 映射效果
![](https://fcpub-1301667576.cos.ap-nanjing.myqcloud.com/flashduty/doc/biaoqian-13.png)

::: highlight orange

如不希望源标签还存在，可以通过删除规则实现

:::